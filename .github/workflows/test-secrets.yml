name: Test Secrets Connectivity

on:
  workflow_dispatch:  # Manual trigger only

jobs:
  test-secrets:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install minimal dependencies
        run: |
          pip install requests supabase anthropic

      - name: Test Supabase Connection
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        run: |
          python -c "
          import os
          from supabase import create_client

          url = os.environ.get('SUPABASE_URL')
          key = os.environ.get('SUPABASE_KEY')

          if not url or not key:
              print('FAIL: SUPABASE_URL or SUPABASE_KEY not set')
              exit(1)

          try:
              client = create_client(url, key)
              # Simple query to test connection
              result = client.table('enriched_jobs').select('id', count='exact', head=True).limit(1).execute()
              print(f'SUCCESS: Supabase connected. enriched_jobs count: {result.count}')
          except Exception as e:
              print(f'FAIL: Supabase connection failed: {e}')
              exit(1)
          "

      - name: Test Anthropic Connection
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          python -c "
          import os
          import anthropic

          key = os.environ.get('ANTHROPIC_API_KEY')

          if not key:
              print('FAIL: ANTHROPIC_API_KEY not set')
              exit(1)

          try:
              client = anthropic.Anthropic(api_key=key)
              # Minimal API call to test auth
              response = client.messages.create(
                  model='claude-3-haiku-20240307',
                  max_tokens=10,
                  messages=[{'role': 'user', 'content': 'Say OK'}]
              )
              print(f'SUCCESS: Anthropic connected. Response: {response.content[0].text}')
          except Exception as e:
              print(f'FAIL: Anthropic connection failed: {e}')
              exit(1)
          "

      - name: Test Adzuna Connection
        env:
          ADZUNA_APP_ID: ${{ secrets.ADZUNA_APP_ID }}
          ADZUNA_API_KEY: ${{ secrets.ADZUNA_API_KEY }}
        run: |
          python -c "
          import os
          import requests

          app_id = os.environ.get('ADZUNA_APP_ID')
          api_key = os.environ.get('ADZUNA_API_KEY')

          if not app_id or not api_key:
              print('FAIL: ADZUNA_APP_ID or ADZUNA_API_KEY not set')
              exit(1)

          try:
              # Simple API call to test auth
              url = f'https://api.adzuna.com/v1/api/jobs/gb/search/1?app_id={app_id}&app_key={api_key}&results_per_page=1&what=test'
              response = requests.get(url, timeout=10)
              response.raise_for_status()
              data = response.json()
              print(f'SUCCESS: Adzuna connected. Found {data.get(\"count\", 0)} total jobs')
          except Exception as e:
              print(f'FAIL: Adzuna connection failed: {e}')
              exit(1)
          "

      - name: Summary
        run: |
          echo "All secrets validated successfully!"
          echo ""
          echo "Ready to create production workflows:"
          echo "  - scrape-lever.yml"
          echo "  - scrape-adzuna.yml"
          echo "  - scrape-greenhouse.yml"
