name: URL Validation & Stats (Mon-Fri 9AM UTC)

# Validates job URLs for 404s and computes employer fill statistics
# Part of: EPIC-008 Curated Job Feed
#
# NOTE: Summary generation has moved inline to classifier.py
# The summary_generator.py script remains as a backfill utility only.

on:
  schedule:
    # Run at 9:00 AM UTC (after Greenhouse batch at 7:00 AM completes)
    - cron: '0 9 * * 1-5'  # Monday-Friday (weekday schedule)
  workflow_dispatch:
    inputs:
      url_limit:
        description: 'Limit for Greenhouse URL validation (blank = check all)'
        required: false
        default: ''
        type: string
      run_employer_stats:
        description: 'Run employer_stats.py after URL validation'
        required: false
        default: true
        type: boolean

jobs:
  url-validation-stats:
    runs-on: ubuntu-latest
    timeout-minutes: 60  # API freshness check (with per-job verification) + Greenhouse URL validation

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Install Playwright browsers
        run: |
          playwright install chromium --with-deps

      # Step 1: API Freshness Check (Lever, Ashby, Workable, SmartRecruiters)
      # Includes per-job verification for Lever/SmartRecruiters
      - name: Run api_freshness_checker.py (SPA sources)
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        run: |
          echo "=========================================="
          echo "STEP 1: API Freshness Check"
          echo "=========================================="
          python pipeline/api_freshness_checker.py

      # Step 2: Greenhouse URL Validation (must run before employer_stats)
      # SPA sources (Lever, Ashby, Workable, SmartRecruiters) handled by api_freshness_checker above
      - name: Run url_validator.py (Greenhouse only)
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        run: |
          echo "=========================================="
          echo "STEP 2: Greenhouse URL Validation"
          echo "=========================================="
          LIMIT="${{ github.event.inputs.url_limit }}"
          if [ -z "$LIMIT" ]; then
            echo "Checking all Greenhouse URLs..."
            python pipeline/url_validator.py
          else
            echo "Checking up to $LIMIT Greenhouse URLs..."
            python pipeline/url_validator.py --limit=$LIMIT
          fi

      # Step 3: Employer Stats (depends on 404 data from URL validation)
      - name: Run employer_stats.py
        if: ${{ github.event.inputs.run_employer_stats != 'false' }}
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        run: |
          echo "=========================================="
          echo "STEP 3: Employer Fill Stats"
          echo "=========================================="
          python pipeline/employer_stats.py

      - name: Summary
        if: always()
        run: |
          python << 'EOF'
          import os
          from datetime import datetime

          with open(os.environ['GITHUB_STEP_SUMMARY'], 'a') as f:
              f.write("## URL Validation & Stats Complete\n\n")
              f.write(f"| Step | Scope | Status |\n")
              f.write(f"|------|-------|--------|\n")
              f.write(f"| **API Freshness Check** | Lever, Ashby, Workable, SmartRecruiters | Complete |\n")
              f.write(f"| **Greenhouse URL Validator** | Greenhouse | Complete |\n")
              f.write(f"| **Employer Stats** | All sources | Complete |\n")
              f.write(f"\n**Timestamp:** {datetime.utcnow().strftime('%Y-%m-%d %H:%M:%S UTC')}\n")
              f.write(f"\n_API freshness checker includes per-job verification for Lever/SmartRecruiters._\n")
          EOF
