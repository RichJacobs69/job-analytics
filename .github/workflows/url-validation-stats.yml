name: URL Validation & Stats (Mon-Fri 9AM UTC)

# Checks job freshness across all 5 ATS sources and computes employer fill statistics
# Part of: EPIC-008 Curated Job Feed
#
# All 5 sources (Greenhouse, Ashby, Lever, Workable, SmartRecruiters) use the same
# model: job present in API listing = active; job absent = closed (soft_404).

on:
  schedule:
    # Run at 9:00 AM UTC (after Greenhouse batch at 7:00 AM completes)
    - cron: '0 9 * * 1-5'  # Monday-Friday (weekday schedule)
  workflow_dispatch:
    inputs:
      run_employer_stats:
        description: 'Run employer_stats.py after freshness check'
        required: false
        default: true
        type: boolean

jobs:
  url-validation-stats:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      # Step 1: API Freshness Check (all 5 ATS sources)
      - name: Run api_freshness_checker.py (all ATS sources)
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        run: |
          echo "=========================================="
          echo "STEP 1: API Freshness Check (all sources)"
          echo "=========================================="
          python pipeline/api_freshness_checker.py

      # Step 2: Employer Stats (depends on freshness data)
      - name: Run employer_stats.py
        if: ${{ github.event.inputs.run_employer_stats != 'false' }}
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        run: |
          echo "=========================================="
          echo "STEP 2: Employer Fill Stats"
          echo "=========================================="
          python pipeline/employer_stats.py

      - name: Summary
        if: always()
        run: |
          python << 'EOF'
          import os
          from datetime import datetime

          with open(os.environ['GITHUB_STEP_SUMMARY'], 'a') as f:
              f.write("## URL Validation & Stats Complete\n\n")
              f.write(f"| Step | Scope | Status |\n")
              f.write(f"|------|-------|--------|\n")
              f.write(f"| **API Freshness Check** | Greenhouse, Ashby, Lever, Workable, SmartRecruiters | Complete |\n")
              f.write(f"| **Employer Stats** | All sources | Complete |\n")
              f.write(f"\n**Timestamp:** {datetime.utcnow().strftime('%Y-%m-%d %H:%M:%S UTC')}\n")
          EOF
